---
- name: Join Worker to Kubernetes Cluster
  hosts: workers
  become: yes
  tasks:
    - name: Check if worker is already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: worker_joined

    - name: Copy join command to worker
      copy:
        src: /tmp/kubernetes_join_command.sh
        dest: /tmp/kubernetes_join_command.sh
        mode: '0755'
      when: not worker_joined.stat.exists

    - name: Join the cluster
      shell: /tmp/kubernetes_join_command.sh
      when: not worker_joined.stat.exists
      register: join_result

    - name: Display join result
      debug:
        msg: "{{ join_result.stdout_lines }}"
      when: not worker_joined.stat.exists

    - name: Clean up join command file
      file:
        path: /tmp/kubernetes_join_command.sh
        state: absent
