---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasource
  namespace: monitoring
data:
  datasource.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus.monitoring.svc.cluster.local:9090
        isDefault: true
        editable: true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-provider
  namespace: monitoring
data:
  dashboard.yml: |
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: 'Kubernetes'
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards
          foldersFromFilesStructure: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: monitoring
data:
  kubernetes-cluster.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "links": [],
      "panels": [
        {
          "title": "Cluster Nodes",
          "type": "stat",
          "gridPos": {"h": 4, "w": 4, "x": 0, "y": 0},
          "targets": [{"expr": "count(kube_node_info)", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"steps": [{"color": "green", "value": null}]}}}
        },
        {
          "title": "Running Pods",
          "type": "stat",
          "gridPos": {"h": 4, "w": 4, "x": 4, "y": 0},
          "targets": [{"expr": "count(kube_pod_status_phase{phase=\"Running\"})", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"steps": [{"color": "green", "value": null}]}}}
        },
        {
          "title": "Total Containers",
          "type": "stat",
          "gridPos": {"h": 4, "w": 4, "x": 8, "y": 0},
          "targets": [{"expr": "count(kube_pod_container_info)", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"steps": [{"color": "green", "value": null}]}}}
        },
        {
          "title": "Cluster Uptime",
          "type": "stat",
          "gridPos": {"h": 4, "w": 4, "x": 12, "y": 0},
          "targets": [{"expr": "time() - min(kube_node_created)", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"unit": "s", "color": {"mode": "thresholds"}, "thresholds": {"steps": [{"color": "green", "value": null}]}}}
        },
        {
          "title": "Failed Pods",
          "type": "stat",
          "gridPos": {"h": 4, "w": 4, "x": 16, "y": 0},
          "targets": [{"expr": "count(kube_pod_status_phase{phase=\"Failed\"}) or vector(0)", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"steps": [{"color": "green", "value": null}, {"color": "red", "value": 1}]}}}
        },
        {
          "title": "Pending Pods",
          "type": "stat",
          "gridPos": {"h": 4, "w": 4, "x": 20, "y": 0},
          "targets": [{"expr": "count(kube_pod_status_phase{phase=\"Pending\"}) or vector(0)", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"color": {"mode": "thresholds"}, "thresholds": {"steps": [{"color": "green", "value": null}, {"color": "orange", "value": 1}]}}}
        },
        {
          "title": "CPU Usage by Node",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
          "targets": [{"expr": "100 - (avg by(instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)", "legendFormat": "{% raw %}{{instance}}{% endraw %}", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"unit": "percent", "min": 0, "max": 100, "custom": {"drawStyle": "line", "fillOpacity": 20}}}
        },
        {
          "title": "Memory Usage by Node",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
          "targets": [{"expr": "(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100", "legendFormat": "{% raw %}{{instance}}{% endraw %}", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"unit": "percent", "min": 0, "max": 100, "custom": {"drawStyle": "line", "fillOpacity": 20}}}
        },
        {
          "title": "Disk Usage by Node",
          "type": "gauge",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
          "targets": [{"expr": "(1 - node_filesystem_avail_bytes{mountpoint=\"/\"} / node_filesystem_size_bytes{mountpoint=\"/\"}) * 100", "legendFormat": "{% raw %}{{instance}}{% endraw %}", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"unit": "percent", "min": 0, "max": 100, "thresholds": {"steps": [{"color": "green", "value": null}, {"color": "yellow", "value": 60}, {"color": "red", "value": 80}]}}}
        },
        {
          "title": "Network Received",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12},
          "targets": [
            {"expr": "rate(node_network_receive_bytes_total{device!~\"lo|veth.*|cni.*|flannel.*\"}[5m])", "legendFormat": "{% raw %}RX {{instance}} {{device}}{% endraw %}", "refId": "A"},
            {"expr": "rate(node_network_transmit_bytes_total{device!~\"lo|veth.*|cni.*|flannel.*\"}[5m])", "legendFormat": "{% raw %}TX {{instance}} {{device}}{% endraw %}", "refId": "B"}
          ],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"unit": "Bps", "custom": {"drawStyle": "line", "fillOpacity": 10}}}
        },
        {
          "title": "Pods by Namespace",
          "type": "piechart",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 20},
          "targets": [{"expr": "count by(namespace) (kube_pod_info)", "legendFormat": "{% raw %}{{namespace}}{% endraw %}", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"}
        },
        {
          "title": "Pod Restarts (Top 10)",
          "type": "table",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 20},
          "targets": [{"expr": "topk(10, kube_pod_container_status_restarts_total > 0)", "refId": "A", "format": "table", "instant": true}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"}
        }
      ],
      "refresh": "10s",
      "schemaVersion": 39,
      "tags": ["kubernetes", "cluster"],
      "templating": {
        "list": [
          {
            "current": {"selected": false, "text": "Prometheus", "value": "Prometheus"},
            "hide": 0,
            "includeAll": false,
            "name": "DS_PROMETHEUS",
            "options": [],
            "query": "prometheus",
            "refresh": 1,
            "type": "datasource"
          }
        ]
      },
      "time": {"from": "now-1h", "to": "now"},
      "title": "Kubernetes Cluster Overview",
      "uid": "k8s-cluster-overview"
    }
  node-exporter.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "panels": [
        {
          "title": "CPU Usage",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 0},
          "targets": [{"expr": "100 - (avg by(instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)", "legendFormat": "{% raw %}{{instance}}{% endraw %}", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"unit": "percent", "min": 0, "max": 100, "custom": {"drawStyle": "line", "fillOpacity": 30, "lineWidth": 2}}}
        },
        {
          "title": "Memory Usage",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8},
          "targets": [{"expr": "(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100", "legendFormat": "{% raw %}{{instance}}{% endraw %}", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"unit": "percent", "min": 0, "max": 100, "custom": {"drawStyle": "line", "fillOpacity": 30, "lineWidth": 2}}}
        },
        {
          "title": "Disk Space Used",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 16},
          "targets": [{"expr": "(1 - node_filesystem_avail_bytes{mountpoint=\"/\"} / node_filesystem_size_bytes{mountpoint=\"/\"}) * 100", "legendFormat": "{% raw %}{{instance}}{% endraw %}", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"unit": "percent", "min": 0, "max": 100, "custom": {"drawStyle": "line", "fillOpacity": 30, "lineWidth": 2}}}
        },
        {
          "title": "System Load (1m)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
          "targets": [{"expr": "node_load1", "legendFormat": "{% raw %}{{instance}}{% endraw %}", "refId": "A"}],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"custom": {"drawStyle": "line", "fillOpacity": 10, "lineWidth": 2}}}
        },
        {
          "title": "Network Traffic",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
          "targets": [
            {"expr": "rate(node_network_receive_bytes_total{device!~\"lo|veth.*|cni.*|flannel.*\"}[5m])", "legendFormat": "{% raw %}RX {{instance}}{% endraw %}", "refId": "A"},
            {"expr": "rate(node_network_transmit_bytes_total{device!~\"lo|veth.*|cni.*|flannel.*\"}[5m])", "legendFormat": "{% raw %}TX {{instance}}{% endraw %}", "refId": "B"}
          ],
          "datasource": {"type": "prometheus", "uid": "${DS_PROMETHEUS}"},
          "fieldConfig": {"defaults": {"unit": "Bps", "custom": {"drawStyle": "line", "fillOpacity": 10, "lineWidth": 2}}}
        }
      ],
      "refresh": "10s",
      "schemaVersion": 39,
      "tags": ["node-exporter", "infrastructure"],
      "templating": {
        "list": [
          {
            "current": {"selected": false, "text": "Prometheus", "value": "Prometheus"},
            "hide": 0,
            "name": "DS_PROMETHEUS",
            "query": "prometheus",
            "refresh": 1,
            "type": "datasource"
          }
        ]
      },
      "time": {"from": "now-1h", "to": "now"},
      "title": "Node Exporter - Infrastructure",
      "uid": "node-exporter-infra"
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:latest
        ports:
        - containerPort: 3000
          name: web
        env:
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: "{{ grafana_admin_password }}"
        - name: GF_USERS_ALLOW_SIGN_UP
          value: "false"
        - name: GF_SERVER_ROOT_URL
          value: "http://{{ ansible_host }}:{{ grafana_nodeport }}"
        - name: GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH
          value: "/var/lib/grafana/dashboards/kubernetes-cluster.json"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
        volumeMounts:
        - name: grafana-storage
          mountPath: /var/lib/grafana
        - name: grafana-datasource
          mountPath: /etc/grafana/provisioning/datasources
        - name: grafana-dashboard-provider
          mountPath: /etc/grafana/provisioning/dashboards
        - name: grafana-dashboards
          mountPath: /var/lib/grafana/dashboards
      volumes:
      - name: grafana-storage
        emptyDir: {}
      - name: grafana-datasource
        configMap:
          name: grafana-datasource
      - name: grafana-dashboard-provider
        configMap:
          name: grafana-dashboard-provider
      - name: grafana-dashboards
        configMap:
          name: grafana-dashboards
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
spec:
  type: NodePort
  ports:
  - port: 3000
    targetPort: 3000
    nodePort: {{ grafana_nodeport }}
    name: web
  selector:
    app: grafana
